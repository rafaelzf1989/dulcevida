<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dulce Vida - Tienda</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="icon" type="image/png" href="https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/favicon.png">
  <style>

html,body { margin:0; padding:0; background:#f5f5f8; font-family:Arial,sans-serif; min-height:100vh; }
    header { background: #fff; box-shadow: 0 2px 8px #0001; text-align: center; padding: 0;}
    .cabecera-wrap { display: flex; justify-content: center; align-items: center; width: 100%; }
#cabeceraImg {
  max-width: 170px;
  height: auto;
  margin: 10px auto 0 auto;
  display: block;
  border-radius: 20px;
  background: #fff;
  object-fit: contain;
}
@media (max-width: 480px) {
  #cabeceraImg {
    max-width: 100vw;
    width: 100vw;
    margin: 0;
    border-radius: 0;
  }
}
    .marquesina {
  background: #25D366;
  color: #fff;
  font-weight: bold;
  font-size: .97em;
  overflow: hidden;
  height: 29px;
  display: flex;
  align-items: center;
}
.marquesina .scroll {
  display: inline-block;
  white-space: nowrap;
  will-change: transform;
}
@keyframes scroll-lr {
  0% { transform: translateX(0);}
  100% { transform: translateX(-50%);}
}
    main { max-width: 700px; margin: 0 auto; padding: 0 0 50px 0; }
    .productos-grid { display:flex; flex-wrap:wrap; gap:17px; justify-content:center; margin:18px 0 0 0;}
    .producto-card { background:#fff; border-radius:22px; box-shadow:0 2px 10px #3b2eae1a; padding:13px 0 15px 0; width:330px; max-width:95vw; display:flex; flex-direction:column; align-items:center; position:relative; overflow:hidden; }
    .producto-card img {
  width: 100%;
  height: 190px;
  object-fit: cover;
  border-radius: 0 0 15px 15px; /* solo redondeo abajo */
  margin-bottom: 6px;
  background: #f3f3f5;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  display: block;
    }
    .producto-nombre { font-weight:bold; color:#3b2eae; font-size:1.09em; padding:3px 0; text-align:center; }
    .producto-precio { color:#25D366; font-weight: bold; font-size:1.03em; margin-bottom:.2em;}
    .producto-estado { display:inline-block; margin-bottom:2px; margin-top:8px; margin-left:10px; text-align:left; background:#3b2eae; color:#fff; font-size:0.81em; font-weight:bold; padding:3px 11px; border-radius:7px; box-shadow:0 1px 5px #3b2eae11; max-width:90%; white-space:nowrap;}
    .producto-card.agotado, .producto-card .producto-estado.agotado { opacity:0.98; pointer-events:none; background: #d2d2d2 !important; }
    .producto-card .producto-estado.agotado { background:#c0392b;}
    .producto-card .agotado-marca { 
      position:absolute; left:-54px; top:38px; z-index:5; 
      width:260px; color:#fff; opacity:0.5; font-size:2.1em; 
      font-weight:bold; text-align:center; 
      transform:rotate(-24deg); pointer-events:none;
      text-shadow: 1px 1px 6px #000;
      user-select:none;
      }
    .producto-desc { font-size:0.99em; color:#222; min-height:38px; text-align:center; }
    .rellenos-lista { width:92%; margin:8px auto 6px auto; display:flex; flex-direction:column; gap:4px;}
    .relleno-row,.cantidad-row { display:flex; align-items:center; gap:7px; font-size:.96em; justify-content:center;}
    .relleno-nombre, .cantidad-nombre { flex:1; }
    .relleno-btn, .cantidad-btn { background:#25D366;color:#fff;border:none;border-radius:50%;width:25px;height:25px;font-weight:bold;font-size:1.1em;cursor:pointer;transition:background 0.18s;}
    .relleno-btn:disabled, .cantidad-btn:disabled { background:#ddd; color:#aaa; cursor:not-allowed;}
    .relleno-cant, .cantidad-cant { width:21px; text-align:center; font-weight:bold; }
    .producto-agregar { margin-top:8px; background:linear-gradient(60deg,#3b2eae 70%, #25D366 100%); color:#fff; border:none; border-radius:9px; font-weight:bold; font-size:1.08em; padding: 8px 28px; cursor:pointer; box-shadow:0 2px 10px #3b2eae11;}
    #errorMsg { color: #c0392b; background: #fff6f6; border: 1px solid #e74c3c; padding: 16px; border-radius: 10px; max-width: 400px; margin: 30px auto; font-size: 1.15em; display:none; text-align:center;}
    #tryAgain { background: #25D366; color: #fff; border: none; border-radius: 6px; padding: 7px 15px; font-weight: bold; margin-top: 10px; font-size: 1em; cursor: pointer;}
    #carritoFlotante { position: fixed; bottom: 18px; right: 13px; z-index: 999; background:linear-gradient(60deg,#3b2eae 70%, #25D366 100%); color:#fff; font-size:1.12em; border-radius:33px; padding:10px 24px 10px 18px; box-shadow:0 2px 14px #231d662c; cursor:pointer; font-weight:bold; display:flex;align-items:center; gap:11px;}
    @media(max-width:400px){
      .producto-card{max-width:99vw; padding:9px 0 13px 0;}
      #cabeceraImg{max-width:100vw;}
      #carritoBox, #cliente { max-width: 99vw; }
      #carritoFlotante{font-size:0.95em;padding:8px 12px 8px 12px;}
    }
    #carritoBox { background:#fff; border-radius:14px; box-shadow:0 2px 10px #3b2eae1a; margin:18px auto 0 auto; padding:13px 12px 6px 12px; max-width:330px; width:99vw;}
    #carritoBox h2 { font-size:1.07em; color:#3b2eae; margin-bottom:7px;}
    .carrito-item { display:flex; align-items:center; gap:6px; border-bottom:1px solid #eee; padding:4px 0; font-size:1em;}
    .carrito-img { width:28px; height:28px; border-radius:6px; object-fit:cover; margin-right:7px; border:1px solid #eee; background:#fafafa;}
    .carrito-cant { width:29px; text-align:center; font-weight:bold;}
    .carrito-btn { background:#25D366;color:#fff;border:none;border-radius:50%;width:21px;height:21px;font-size:1em;font-weight:bold;cursor:pointer;margin:0 1px;}
    .carrito-btn:disabled{background:#ddd;color:#aaa;}
    .carrito-totals-row,.carrito-total-row{display:flex;justify-content:space-between;margin-top:2px;font-size:.98em;}
    .carrito-total-row{font-weight:bold;color:#3b2eae;font-size:1.13em;}
    .carrito-total-valor{font-weight:bold;color:#25D366;}
    .carrito-totals-row label, .carrito-total-row label {font-weight:bold;}
    .empty-cart{text-align:center;color:#aaa;font-style:italic;margin:12px 0;}
    #cliente{background:#fff;border-radius:14px;box-shadow:0 2px 10px #3b2eae1a;margin:18px auto 25px auto;padding:11px 12px 8px 12px;max-width:330px;width:99vw;}
    #cliente h3{color:#3b2eae;margin-bottom:8px;font-size:1.1em;}
    #clienteForm label{font-weight:bold;color:#3b2eae;margin-top:7px;display:block;}
    #clienteForm input,#clienteForm select,#clienteForm textarea{margin-bottom:8px;padding:6px 9px;border-radius:7px;border:1px solid #ccc;width:100%;font-size:1em;box-sizing:border-box;}
    #clienteForm textarea{min-height:52px;}
    #clienteForm button{background:linear-gradient(60deg,#3b2eae 70%, #25D366 100%);color:#fff;border:none;border-radius:10px;font-weight:bold;font-size:1.08em;padding:8px 22px;margin-top:9px;cursor:pointer;box-shadow:0 2px 10px #3b2eae11;display:flex;align-items:center;gap:7px;}
    #mensajeCompra{color:#25D366;font-weight:bold;text-align:center;margin:10px 0 0 0;}
    .modal-bg{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.2);z-index:9999;display:flex;align-items:center;justify-content:center;}
    .modal-confirm{background:#fff;padding:17px 15px 15px 15px;border-radius:13px;box-shadow:0 2px 12px #3b2eae22;max-width:330px;width:96vw;font-size:1.03em;}
    .modal-confirm h2{font-size:1.12em;color:#3b2eae;}
    .modal-section{margin:7px 0 6px 0;}
    .modal-total-row{display:flex;justify-content:space-between;font-weight:bold;color:#25D366;font-size:1.1em;}
    .modal-btns{display:flex;gap:14px;justify-content:flex-end;margin-top:15px;}
    .btn-confirmar{background:#25D366;color:#fff;padding:7px 20px;border-radius:8px;font-weight:bold;font-size:1em;border:none;cursor:pointer;}
    .btn-cancelar{background:#eee;color:#3b2eae;padding:7px 15px;border-radius:8px;font-weight:bold;font-size:.98em;border:none;cursor:pointer;}
    #imgModal {position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:99999;display:flex;align-items:center;justify-content:center;}
    #imgModal img {max-width:93vw;max-height:88vh;border-radius:17px;box-shadow:0 2px 18px #111b;}
 

/* Paleta de colores Dulce Vida + WhatsApp */

header {
  background: #fff;
  box-shadow: 0 2px 8px #e959d433;
}

/* Marquesina */
.marquesina {
  background: #25D366 !important;
  color: #fff !important;
}

/* Estado “Disponible” */
.producto-estado {
  background: #ff4eb5 !important;
  color: #fff !important;
}

/* Nombre producto */
.producto-nombre {
  color: #3b2eae !important;
}

/* Precio producto */
.producto-precio {
  color: #25D366 !important;
}

/* Botón Agregar al Carrito */
.producto-agregar {
  background: linear-gradient(90deg, #25D366 60%, #ff4eb5 100%) !important;
  color: #fff !important;
  border-radius: 12px !important;
  font-weight: bold;
  border: none;
  box-shadow: 0 2px 10px #3b2eae1a;
}

.producto-agregar:hover, .producto-agregar:focus {
  background: linear-gradient(90deg, #ff4eb5 20%, #25D366 100%) !important;
}

/* Relleno y cantidad botones */
.relleno-btn, .cantidad-btn, .carrito-btn {
  background: #ff4eb5 !important;
  color: #fff !important;
}

.relleno-btn:disabled, .cantidad-btn:disabled, .carrito-btn:disabled {
  background: #ddd !important;
  color: #aaa !important;
}

/* Carrito Totales */
.carrito-total-row {
  color: #3b2eae !important;
}
.carrito-total-valor {
  color: #25D366 !important;
}

/* Botón Vaciar carrito */
#carritoBox button[onclick*="vaciarCarrito"] {
  background: #ff4eb5 !important;
  color: #fff !important;
}

/* Formulario */
#clienteForm label {
  color: #ff4eb5 !important;
}
#clienteForm button {
  background: linear-gradient(90deg, #25D366 60%, #ff4eb5 100%) !important;
  color: #fff !important;
}

/* Sombra y detalles */
.producto-card, #carritoBox, #cliente {
  box-shadow: 0 2px 10px #ff4eb51a !important;
}

.producto-card {
  position: relative;
}

.producto-estado {
  position: absolute !important;
  top: 0;
  left: 0;
  z-index: 2;
  border-radius: 0 0 12px 0;
  background: #ff4eb5 !important; /* o el color que prefieras */
  color: #fff !important;
  padding: 6px 18px 6px 12px;
  font-size: 0.97em;
  font-weight: bold;
  box-shadow: 0 2px 8px #ff4eb522;
  margin: 0 !important;
}
    
    
  </style>
</head>
<body>

  
<header>
  <div class="cabecera-wrap">
    <img id="cabeceraImg" alt="Dulce Vida" />
  </div>
</header>
<div class="marquesina"><div class="scroll" id="marquesinaScroll"></div></div>
<main>
    <div id="errorMsg"></div>
  <section id="productos" class="productos-grid" aria-label="Lista de productos"></section>
  <section id="carritoBox" style="margin-top:20px;">
    <h2>Carrito 🛒</h2>
    <div id="listaCarrito"></div>
    <div class="carrito-totals-row"><label>Subtotal:</label><span id="subtotalCarrito">0</span> CUP</div>
    <div class="carrito-totals-row"><label>Envío:</label><span id="envioCarrito">0</span> CUP</div>
    <div class="carrito-total-row"><label>TOTAL:</label><span class="carrito-total-valor" id="totalFinalBox">0 CUP</span></div>
    <div style="text-align:right;"><button onclick="vaciarCarrito()" style="background:#e74c3c;padding:6px 19px;font-size:.98em;border-radius:7px;">Vaciar carrito</button></div>
  </section>
  <section id="cliente" aria-label="Formulario de datos del cliente">
    <h3>📝 Datos del Cliente</h3>
    <form id="clienteForm" autocomplete="off" onsubmit="return false;">
      <label>Código país:</label>
      <select id="codigoPais" required>
        <option value="53" selected>🇨🇺 +53 Cuba</option>
        <option value="1">🇺🇸 +1 USA</option>
        <option value="34">🇪🇸 +34 España</option>
        <option value="52">🇲🇽 +52 México</option>
        <option value="55">🇧🇷 +55 Brasil</option>
        <option value="507">🇵🇦 +507 Panamá</option>
        <option value="58">🇻🇪 +58 Venezuela</option>
        <option value="54">🇦🇷 +54 Argentina</option>
        <option value="57">🇨🇴 +57 Colombia</option>
      </select>
      <label>Teléfono:</label>
      <input type="tel" id="telefono" required maxlength="15" autocomplete="tel" placeholder="Ej: 58707434" pattern="[0-9]+" />
      <label>Nombre completo:</label>
      <input type="text" id="nombre" required maxlength="60" autocomplete="name" placeholder="Ej: Ana Pérez" />
      <label>¿Desea entrega a domicilio?</label>
      <select id="entrega" required onchange="mostrarDireccion()"><option value="no" selected>Retiro en tienda</option><option value="si">Sí, entrega a domicilio</option></select>
      <div id="direccionEntrega" style="display:none;">
        <label>Dirección:</label>
        <input type="text" id="direccion" maxlength="100" placeholder="Ej: Calle 1ra #100 entre 2 y 4" />
        <label>Reparto:</label>
        <select id="reparto"></select>
      </div>
      <label>Fecha y hora de entrega:</label>
      <input type="datetime-local" id="fechaEntrega" required />
      <label>Especificaciones del pedido:</label>
      <textarea id="especificaciones" maxlength="300" placeholder="¿Quieres algún detalle especial, dedicatoria, etc.?"></textarea>
      <button id="btnEnviar" type="button" onclick="mostrarResumenConfirmacion()" style="display:flex;align-items:center;gap:8px;">
        <img src="https://file.garden/aEX2yhToiQk-s_Qq/IMG_COM_202506261242078500.png" alt="Icono WhatsApp" style="width:20px;height:20px;object-fit:contain;" />
        Enviar por WhatsApp
      </button>
    </form>
    <p id="mensajeCompra"></p>
  </section>
</main>
<div id="carritoFlotante" onclick="document.getElementById('carritoBox').scrollIntoView({behavior:'smooth'});" aria-label="Ver carrito" tabindex="0" style="display:none;">🛒 <span id="contadorCarrito">0</span></div>
<script>
const endpoint = "https://script.google.com/macros/s/AKfycbypavkuPIoD7ru-SG7JFyLqCvOJ9kSbOjt5iNMrcJZuqtMuSihav20PbkF4uWiO1vCe/exec?func=catalogo";
const configEndpoint = "https://script.google.com/macros/s/AKfycbypavkuPIoD7ru-SG7JFyLqCvOJ9kSbOjt5iNMrcJZuqtMuSihav20PbkF4uWiO1vCe/exec?func=config";
let productosData = [];
let carrito = [];
let cantidadesPorProducto = {};
let rellenosPorProducto = {};
let repartosConfig = [];
let repartosPrecios = {};
let velocidadMarquesina = 18;
let envioActual = 0;

// Configuración y cabecera
function cargarConfiguraciones() {
  fetch(configEndpoint).then(r=>r.json()).then(config=>{
    // DUPLICA el texto y añade espacio entre ellos para el bucle
    let texto = config.anuncio || '¡Bienvenido!';
    document.getElementById('marquesinaScroll').innerHTML = texto + "&nbsp;&nbsp;&nbsp;&nbsp;" + texto;
    velocidadMarquesina = config.velocidad || 18;
    repartosConfig = config.repartos || [];
    repartosPrecios = config.repartosPrecios || {};
    actualizarRepartos();
    setMarquesinaSpeed();
    if(config.cabeceraImg) {
      document.getElementById('cabeceraImg').src = config.cabeceraImg;
    }
  }).catch(()=>{
    let texto = "¡Bienvenido!";
    document.getElementById('marquesinaScroll').innerHTML = texto + "&nbsp;&nbsp;&nbsp;&nbsp;" + texto;
    setMarquesinaSpeed();
  });
}
function setMarquesinaSpeed() {
  const el = document.querySelector('.marquesina .scroll');
  if(el) {
    el.style.animation = `scroll-lr ${velocidadMarquesina}s linear infinite`;
    el.style.webkitAnimation = `scroll-lr ${velocidadMarquesina}s linear infinite`;
  }
}
function actualizarRepartos() {
  const select = document.getElementById('reparto');
  select.innerHTML = '<option value="">Selecciona reparto</option>';
  repartosConfig.forEach(r=>{
    select.innerHTML += `<option value="${r}">${r}</option>`;
  });
  // ¡Agrega este evento!
  select.onchange = actualizarCarrito;
}
cargarConfiguraciones();

// -----AJUSTAR CABECERA-----
// window.addEventListener('resize', ajustarCabeceraImg);
// window.addEventListener('DOMContentLoaded', ajustarCabeceraImg);
// function ajustarCabeceraImg() {
//   let img = document.getElementById('cabeceraImg');
//   img.style.width = "330px";
//   img.style.maxWidth = "95vw";
//   img.style.height = "110px";
//   if(window.innerWidth < 500) {
//     img.style.width = "99vw";
//     img.style.height = "70px";
//   }
// }

// Productos
function mostrarError(msg) {
  document.getElementById('errorMsg').innerHTML = `<div>${msg}</div><button id="tryAgain" onclick="window.location.reload()">Reintentar</button>`;
  document.getElementById('errorMsg').style.display = 'block';
  document.getElementById('productos').style.display = 'none';
  document.getElementById('carritoBox').style.display = 'none';
  document.getElementById('cliente').style.display = 'none';
}
function ocultarError() {
  document.getElementById('errorMsg').style.display = 'none';
  document.getElementById('productos').style.display = '';
  document.getElementById('carritoBox').style.display = '';
  document.getElementById('cliente').style.display = '';
}
function cargarProductos() {
  fetch(endpoint).then(r=>{
    if(!r.ok) throw new Error('Respuesta HTTP no válida');
    return r.json();
  }).then(datos=>{
    productosData = datos;
    datos.forEach((prod, idx)=>{
      cantidadesPorProducto[idx]=0;
      rellenosPorProducto[idx]=prod.Rellenos.map(()=>0);
    });
    ocultarError();
    renderProductos(); actualizarCarrito();
  }).catch(err=>{
    mostrarError("No se pudieron cargar los productos desde la hoja de Google Sheets.<br><small>Error: "+err.message+"</small>");
  });
}
cargarProductos();

function renderProductos() {
  const cont = document.getElementById('productos');
  cont.innerHTML = '';
  productosData.forEach((p, idx) => {
    let estadoTxt = p.Estado || "";
    let agotado = (estadoTxt.trim().toLowerCase() === "agotado");
    let rellenosHTML = '';
    // Si el producto tiene rellenos, mostrar radio buttons
    if (p.Rellenos && p.Rellenos.length > 0) {
      rellenosHTML = `<div class="rellenos-lista">` +
        p.Rellenos.map((r, ridx) =>
          `<label style="display:block;margin-bottom:3px;">
            <input type="radio" name="relleno_${idx}" value="${r}"
              ${rellenosPorProducto[idx][ridx] === 1 ? "checked" : ""}
              onchange="seleccionarRellenoUnico(${idx}, ${ridx})"
              ${agotado ? 'disabled' : ''}>
            ${r}
          </label>`
        ).join('') +
        `</div>`;
    }
    cont.innerHTML += `
      <div class="producto-card${agotado ? ' agotado' : ''}">
        ${agotado ? `<div class="agotado-marca">AGOTADO</div>` : ""}
        ${estadoTxt ? `<div class="producto-estado${agotado ? ' agotado' : ''}">${estadoTxt}</div>` : ''}
        <img src="${p.Imagen || ''}" alt="${p.Nombre}" onclick="mostrarImagenCompleta('${encodeURIComponent(p.Imagen || '')}')">
        <div class="producto-nombre">${p.Nombre}</div>
        <div class="producto-precio">${p.Precio} CUP</div>
        <div class="producto-desc">${p.Descripción || ''}</div>
        <div class="cantidad-row">
          <span class="cantidad-nombre"></span>
          <button class="cantidad-btn" onclick="cambiarCantidad(${idx},-1)" ${agotado ? 'disabled' : ''}>−</button>
          <span class="cantidad-cant" id="cant${idx}">${cantidadesPorProducto[idx]}</span>
          <button class="cantidad-btn" onclick="cambiarCantidad(${idx},1)" ${agotado ? 'disabled' : ''}>+</button>
        </div>
        ${rellenosHTML}
        <button class="producto-agregar" onclick="agregarAlCarrito(${idx})" ${agotado ? 'disabled' : ''}>Agregar al Carrito</button>
      </div>
    `;
  });
}
function mostrarImagenCompleta(url) {
  url = decodeURIComponent(url);
  let modal = document.createElement('div');
  modal.id = 'imgModal';
  modal.innerHTML = `<img src="${url}" onclick="document.body.removeChild(document.getElementById('imgModal'))" alt="Imagen producto" />`;
  modal.onclick = ()=>document.body.removeChild(modal);
  document.body.appendChild(modal);
}
function cambiarCantidad(idx, delta) {
  cantidadesPorProducto[idx] = Math.max(0, (cantidadesPorProducto[idx]||0) + delta);
  document.getElementById('cant'+idx).textContent = cantidadesPorProducto[idx];
}
function cambiarRelleno(idx, ridx, delta) {
  rellenosPorProducto[idx][ridx] = Math.max(0, (rellenosPorProducto[idx][ridx]||0) + delta);
  document.getElementById('rcant'+idx+"_"+ridx).textContent = rellenosPorProducto[idx][ridx];
}
function agregarAlCarrito(idx) {
  let cantidad = cantidadesPorProducto[idx]||0;
  if (cantidad<1) { mostrarToast('Selecciona al menos una unidad.'); return; }
  let prod = productosData[idx];
  let rellenos = [];
  if (prod.Rellenos && prod.Rellenos.length>0) {
    rellenos = prod.Rellenos.map((r, ridx) =>
      rellenosPorProducto[idx][ridx]>0
        ? `${r} x${rellenosPorProducto[idx][ridx]}`
        : null
    ).filter(Boolean);
  }
  carrito.push({
    idx,
    nombre: prod.Nombre,
    precio: prod.Precio,
    cantidad,
    rellenos: rellenos.length ? rellenos.join(', ') : ""
  });
  cantidadesPorProducto[idx]=0;
  rellenosPorProducto[idx]=prod.Rellenos.map(()=>0);
  renderProductos(); actualizarCarrito();
  mostrarToast('Producto agregado al carrito');
  document.getElementById('carritoFlotante').style.display = carrito.length ? "flex" : "none";
}
function actualizarCarrito() {
  const lista = document.getElementById('listaCarrito');
  lista.innerHTML = '';
  let subtotal = 0;
  if (carrito.length === 0) {
    lista.innerHTML = `<div class="empty-cart">El carrito está vacío. Añade productos para continuar.</div>`;
  } else {
    carrito.forEach((item, i) => {
      subtotal += item.precio * item.cantidad;
lista.innerHTML += `
  <div class="carrito-item">
    <img src="${productosData[item.idx].Imagen||''}" class="carrito-img" alt="${item.nombre}">
    <div style="flex:1; min-width:90px;">
      <span>${item.nombre}</span>
      ${item.rellenos ? `<div style="font-size:0.92em; color:#231d66; margin-top:2px;">${item.rellenos}</div>` : ""}
    </div>
    <div class="carrito-cant">${item.cantidad}</div>
    <button class="carrito-btn" onclick="cambiarCantidadCarrito(${i},-1)">−</button>
    <button class="carrito-btn" onclick="cambiarCantidadCarrito(${i},1)">+</button>
    <span style="min-width:65px;">${item.precio * item.cantidad} CUP</span>
    <button onclick="quitarDelCarrito(${i})" aria-label="Quitar">❌</button>
  </div>
`;
    });
  }
  let envio = calcularEnvio();
  envioActual = envio;
  document.getElementById('subtotalCarrito').textContent = subtotal;
  document.getElementById('envioCarrito').textContent = envio;
  document.getElementById('totalFinalBox').textContent = (subtotal + envio) + " CUP";
  document.getElementById('contadorCarrito').textContent = carrito.reduce((acc, i) => acc + i.cantidad, 0);
}
function calcularEnvio() {
  let entrega = document.getElementById('entrega')?.value;
  if (entrega === "si") {
    let reparto = document.getElementById('reparto')?.value;
    if (reparto && repartosPrecios[reparto]) return repartosPrecios[reparto];
  }
  return 0;
}
function cambiarCantidadCarrito(idx, delta) {
  carrito[idx].cantidad += delta;
  if (carrito[idx].cantidad < 1) quitarDelCarrito(idx);
  actualizarCarrito();
}
function quitarDelCarrito(idx) {
  carrito.splice(idx, 1);
  actualizarCarrito();
  document.getElementById('carritoFlotante').style.display = carrito.length ? "flex" : "none";
}
function vaciarCarrito() {
  carrito = [];
  actualizarCarrito();
  document.getElementById('carritoFlotante').style.display = "none";
}
function mostrarToast(msg) {
  let toast = document.createElement('div');
  toast.style.position = 'fixed';
  toast.style.bottom = '35px';
  toast.style.left = '50%';
  toast.style.transform = 'translateX(-50%)';
  toast.style.background = '#3b2eae';
  toast.style.color = '#fff';
  toast.style.padding = '12px 34px';
  toast.style.fontSize = '1em';
  toast.style.borderRadius = '12px';
  toast.style.boxShadow = '0 2px 10px #1116';
  toast.style.zIndex = '9000';
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(()=>{ toast.style.opacity = "0"; }, 1500);
  setTimeout(()=>{ if (toast.parentNode) toast.parentNode.removeChild(toast); }, 1900);
}
function mostrarDireccion() {
  let entrega = document.getElementById('entrega').value;
  document.getElementById('direccionEntrega').style.display = (entrega === "si" ? "block" : "none");
  actualizarCarrito();
}
function mostrarResumenConfirmacion() {
  if (carrito.length === 0) { mostrarToast('El carrito está vacío.'); return; }
  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const codigoPais = document.getElementById('codigoPais').value.trim();
  const entrega = document.getElementById('entrega').value;
  const direccion = entrega === 'si' ? document.getElementById('direccion').value.trim() : '';
  const reparto = entrega === 'si' ? document.getElementById('reparto').value.trim() : '';
  const fechaEntrega = document.getElementById('fechaEntrega').value;
  const especificaciones = document.getElementById('especificaciones').value.trim();
  if (!nombre) { mostrarToast('Debes ingresar tu nombre.'); return; }
  if (!telefono.match(/^[0-9]{7,15}$/)) { mostrarToast('El teléfono debe ser numérico y válido.'); return; }
  if (!fechaEntrega) { mostrarToast('Debes seleccionar la fecha y hora de entrega.'); return; }
  if (entrega === 'si' && !direccion) { mostrarToast('Debes ingresar una dirección.'); return; }
  if (entrega === 'si' && !reparto) { mostrarToast('Debes seleccionar el reparto.'); return; }
  let subtotal = carrito.reduce((s, i) => s + i.precio * i.cantidad, 0);
  let envio = calcularEnvio();
  let total = subtotal + envio;
  let ticket = "PED-" + Date.now() + "-" + Math.floor(Math.random()*1000);
  function b(s){return `*${s}*`;}
  let resumenHtml = `
    <div class="modal-section"><b>🧾 Ticket:</b> <span style="font-size:1.07em;">${ticket}</span></div>
    <div class="modal-section"><b>🍰 Productos:</b>
      <ul style="list-style:none;padding:0; margin:5px 0 0 0;">
        ${carrito.map(i=>`<li style="margin-bottom:3px;">${i.nombre}${i.rellenos?' ('+i.rellenos+')':''} x${i.cantidad} = ${i.precio * i.cantidad} CUP</li>`).join("")}
      </ul>
    </div>
    <div class="modal-section"><b>👤 Cliente:</b> ${nombre}</div>
    <div class="modal-section"><b>📞 Tel:</b> +${codigoPais} ${telefono}</div>
    ${entrega==="si"?`<div class="modal-section"><b>🏠 Dirección:</b> ${direccion}</div>`:""}
    ${entrega==="si"?`<div class="modal-section"><b>📍 Reparto:</b> ${reparto}</div>`:""}
    <div class="modal-section"><b>🚚 Entrega:</b> ${entrega==="si"?"A domicilio":"Retiro en tienda"}</div>
    <div class="modal-section"><b>📅 Fecha y hora:</b> ${fechaEntrega.replace("T"," ")}</div>
    ${especificaciones?`<div class="modal-section"><b>📋 Especificaciones:</b> ${especificaciones}</div>`:""}
    <div class="modal-section" style="margin-top:6px;">
      <div style="color:#3b2eae;font-weight:bold;">Subtotal: <span style="color:#222;">${b(subtotal+" CUP")}</span></div>
      <div style="color:#3b2eae;font-weight:bold;">Envío: <span style="color:#222;">${b(envio+" CUP")}</span></div>
      <div style="color:#25D366;font-weight:bold;font-size:1.12em;">TOTAL: <span style="color:#222;">${b(total+" CUP")}</span></div>
    </div>
  `;
  let modal = document.createElement('div');
  modal.className = "modal-bg";
  modal.innerHTML = `
    <div class="modal-confirm">
      <h2>Confirmar pedido</h2>
      ${resumenHtml}
      <div class="modal-btns">
        <button class="btn-cancelar" onclick="document.body.removeChild(this.closest('.modal-bg'));">Cancelar</button>
        <button class="btn-confirmar" onclick="confirmarEnvioPedido('${ticket}')">Confirmar y enviar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}
function confirmarEnvioPedido(ticket) {
  enviarPedido(ticket);
  document.body.querySelector('.modal-bg')?.remove();
}
function enviarPedido(ticket) {
  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const direccion = document.getElementById('direccion').value.trim();
  const reparto = document.getElementById('reparto').value.trim();
  const codigoPais = document.getElementById('codigoPais').value.trim();
  const entrega = document.getElementById('entrega').value;
  const fechaEntrega = document.getElementById('fechaEntrega').value;
  const especificaciones = document.getElementById('especificaciones').value.trim();
  let subtotal = carrito.reduce((s, i) => s + i.precio * i.cantidad, 0);
  let envio = calcularEnvio();
  let total = subtotal + envio;
  let productosResumen = carrito.map(i =>
    `${i.nombre}${i.rellenos?' ('+i.rellenos+')':''} x${i.cantidad}`
  ).join('; ');
  fetch("https://script.google.com/macros/s/AKfycbypavkuPIoD7ru-SG7JFyLqCvOJ9kSbOjt5iNMrcJZuqtMuSihav20PbkF4uWiO1vCe/exec", {
    method: "POST",
    body: new URLSearchParams({
      nombre,
      telefono,
      direccion,
      reparto,
      codigo_pais: codigoPais,
      productos: productosResumen,
      especificaciones,
      subtotal,
      envio,
      total,
      entrega,
      fecha_entrega: fechaEntrega,
      estado: "Pendiente",
      ticket
    })
  }).then(r=>r.text()).then(resp=>{
    if(resp.startsWith("OK")) {
      mostrarToast("¡Pedido enviado!");
      vaciarCarrito();
      document.getElementById('clienteForm').reset();
      actualizarCarrito();
    } else {
      mostrarToast("Error al guardar el pedido.");
    }
  }).catch(()=>{
    mostrarToast("No se pudo enviar el pedido.");
  });
  // WhatsApp
  function b(s){return `*${s}*`;}
  let resumen = '*Solicitud de Pedido*\n🎫 *Ticket:* ' + ticket + '\n';
  resumen += '\n🍰 *Productos:*\n';
  carrito.forEach(i => { resumen += `- ${i.nombre}${i.rellenos ? ' ('+i.rellenos+')' : ''} x${i.cantidad} = ${i.precio * i.cantidad} CUP\n`; });
  resumen += '\n👤 *Cliente:* ' + nombre + '\n';
  resumen += '📞 *Tel:* +' + codigoPais + ' ' + telefono + '\n';
  if (direccion) resumen += '🏠 *Dirección:* ' + direccion + '\n';
  if (reparto) resumen += '📍 *Reparto:* ' + reparto + '\n';
  resumen += '🚚 *Entrega:* ' + (entrega==="si"?"A domicilio":"Retiro en tienda") + '\n';
  // Formatear fecha y hora al formato 17/07/2025 - 09:30 AM
let fechaMostrada = fechaEntrega;
try {
  let dt = new Date(fechaEntrega);
  let dia = ("0"+dt.getDate()).slice(-2);
  let mes = ("0"+(dt.getMonth()+1)).slice(-2);
  let anio = dt.getFullYear();
  let horas = dt.getHours();
  let minutos = ("0"+dt.getMinutes()).slice(-2);
  let suf = horas >= 12 ? "PM" : "AM";
  let horas12 = horas % 12 || 12;
  fechaMostrada = `${dia}/${mes}/${anio} - ${("0"+horas12).slice(-2)}:${minutos} ${suf}`;
} catch(e) {}
resumen += '📅 *Fecha y hora:* ' + fechaMostrada + '\n';
  if (especificaciones) resumen += '📋 *Especificaciones:* ' + especificaciones + '\n';
  resumen += '\n============================\n';
  resumen += '💲 *Subtotal:* ' + b(subtotal+" CUP") + '\n';
  resumen += '📦 *Envío:* ' + b(envio+" CUP") + '\n';
  resumen += '💰 *TOTAL:* ' + b(total+" CUP") + '\n';
  resumen += '============================';
  let numeroWsp = "5358707434";
  let urlWsp = `https://wa.me/${numeroWsp}?text=${encodeURIComponent(resumen)}`;
  setTimeout(()=>{ window.open(urlWsp, '_blank'); }, 350);
}

  document.addEventListener('DOMContentLoaded', function() {
  const dt = new Date();
  // Ajusta minutos a múltiplo de 5 (opcional)
  dt.setMinutes(Math.ceil(dt.getMinutes() / 5) * 5, 0, 0);
  const pad = n => n.toString().padStart(2, '0');
  // Formato: YYYY-MM-DDTHH:MM
  const localISOTime = dt.getFullYear() + '-' +
    pad(dt.getMonth() + 1) + '-' +
    pad(dt.getDate()) + 'T' +
    pad(dt.getHours()) + ':' +
    pad(dt.getMinutes());
  document.getElementById('fechaEntrega').setAttribute('min', localISOTime);
});

let loadedProducts = false, loadedConfig = false;

function hideLoadingWhenReady() {
  if (loadedProducts && loadedConfig) {
    document.getElementById('loading')?.setAttribute('style', 'display:none;');
  }
}

// Modifica tus funciones fetch para marcar cuando terminan:
const oldCargarProductos = cargarProductos;
cargarProductos = function() {
  fetch(endpoint).then(r=>{
    if(!r.ok) throw new Error('Respuesta HTTP no válida');
    return r.json();
  }).then(datos=>{
    productosData = datos;
    datos.forEach((prod, idx)=>{
      cantidadesPorProducto[idx]=0;
      rellenosPorProducto[idx]=prod.Rellenos.map(()=>0);
    });
    ocultarError();
    renderProductos(); actualizarCarrito();
    loadedProducts = true;
    hideLoadingWhenReady();
  }).catch(err=>{
    mostrarError("No se pudieron cargar los productos desde la hoja de Google Sheets.<br><small>Error: "+err.message+"</small>");
    loadedProducts = true;
    hideLoadingWhenReady();
  });
};

function seleccionarRellenoUnico(idx, ridx) {
  // Solo permite uno seleccionado: pone 1 al elegido y 0 a los demás
  rellenosPorProducto[idx] = rellenosPorProducto[idx].map((_, i) => i === ridx ? 1 : 0);
  renderProductos();
}
</script>
</body>
</html>
